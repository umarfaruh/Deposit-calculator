<html lang="ru">
<head>
  <h1><big><strong>Финансовый калькулятор </strong></big></h1>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калькулятор депозита</title>
  <meta name="google-site-verification" content="28908QYytl5VqHpKiFoXl3oY_W6LMl2bxNexzMY3yZA" />
<style>
  body {
    background: #f3f6fb;
    font-family: "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
  }

  .tabs-wrap {
    max-width: 1200px;
    margin: 30px auto;
    padding: 20px;
  }

  .tabs-container {
    position: relative;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }

  .tabs-track {
    display: flex;
    gap: 14px;
    transition: transform 0.35s ease;
    will-change: transform;
    padding: 16px;
  }

  .tab {
    min-width: 260px;
    flex: 0 0 auto;
    background: linear-gradient(180deg, #f8fbff, #fff);
    padding: 16px;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(17, 24, 39, 0.08);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .tab:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 18px rgba(17, 24, 39, 0.12);
  }

  .tab h4 {
    margin: 0 0 8px;
    font-size: 17px;
  }

  .tab p {
    margin: 0;
    color: #6b7280;
    font-size: 14px;
    flex: 1;
  }

  .tab a {
    display: inline-block;
    margin-top: 12px;
    padding: 10px 14px;
    background: #050506;
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    text-align: center;
    transition: background 0.25s ease;
  }

  .tab a:hover {
    background: #2971ff;
  }

  .tabs-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: #050506;
    color: #fff;
    width: 50px;
    height: 50px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 22px rgba(23, 102, 255, 0.18);
    font-size: 22px;
    transition: background 0.25s ease, transform 0.25s ease;
  }

  .tabs-btn:hover {
    background: #2971ff;
    transform: translateY(-50%) scale(1.05);
  }

  .tabs-btn.left {
    left: 10px;
  }

  .tabs-btn.right {
    right: 10px;
  }

  .tabs-btn:disabled {
    opacity: 0.45;
    cursor: default;
    transform: translateY(-50%);
  }

  @media (max-width: 768px) {
    .tab {
      min-width: 200px;
    }

    .tabs-btn {
      width: 40px;
      height: 40px;
      font-size: 18px;
    }
  }
</style>
</head>
<body>

<div class="tabs-wrap">
  <div class="tabs-container" id="tabsContainer">
    <button class="tabs-btn left" id="btnLeft">&larr;</button>
    <div class="tabs-track" id="tabsTrack">
      <div class="tab">
        <h4>Доходы и рассходы</h4>
        <a href="https://umarfaruh.github.io/budget.rk/">Перейти</a>
      </div>
      <div class="tab">
        <h4>Налоговый калькулятор</h4>
        <a href="https://umarfaruh.github.io/financial_management/">Перейти</a>
      </div>
      <div class="tab">
        <h4>Накопитель</h4>
        <a href="https://umarfaruh.github.io/Expenses-calculate-your-expenses-correctly/">Перейти</a>
      </div>
      <div class="tab">
        <h4>Калькулятор ипотеки</h4>
        <a href="https://umarfaruh.github.io/mortgage/">Перейти</a>
      </div>
      <div class="tab">
        <h4>Калькулятор депозита</h4>
        <a href="https://umarfaruh.github.io/Deposit-calculator/">Перейти</a>
      </div>
      <div class="tab">
        <h4>Калькулятор депозита 2</h4>
        <a href="https://umarfaruh.github.io/Deposit-interest-calculator/">Перейти</a>
      </div>
    </div>
    <button class="tabs-btn right" id="btnRight">&rarr;</button>
  </div>
</div>

<script>
(function(){
  const track = document.getElementById('tabsTrack');
  const container = document.getElementById('tabsContainer');
  const btnL = document.getElementById('btnLeft');
  const btnR = document.getElementById('btnRight');
  let pos = 0;
  let maxScroll = 0;
  let startX = 0, dragStart = 0, isDown = false;

  function updateLimits(){
    const trackWidth = track.scrollWidth;
    const viewport = container.clientWidth;
    maxScroll = Math.max(0, trackWidth - viewport);
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    btnL.disabled = pos === 0;
    btnR.disabled = Math.abs(pos) >= maxScroll;
  }

  function scrollBy(direction){
    const step = Math.round(container.clientWidth * 0.6);
    pos += (direction === 'left') ? step : -step;
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  }

  btnL.addEventListener('click', ()=> scrollBy('left'));
  btnR.addEventListener('click', ()=> scrollBy('right'));

  track.addEventListener('pointerdown', (e)=>{
    isDown = true;
    startX = e.clientX;
    dragStart = pos;
    track.style.transition = 'none';
    track.setPointerCapture(e.pointerId);
  });
  window.addEventListener('pointermove', (e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX;
    pos = dragStart + dx;
    if(pos > 80) pos = 80;
    if(pos < -maxScroll - 80) pos = -maxScroll - 80;
    track.style.transform = `translateX(${pos}px)`;
  });
  window.addEventListener('pointerup', ()=>{
    if(!isDown) return;
    isDown = false;
    track.style.transition = 'transform .35s ease';
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  });
  window.addEventListener('resize', updateLimits);
  window.addEventListener('load', ()=> setTimeout(updateLimits, 80));
})();
</script>





<script>
(function(){
  const track = document.getElementById('tabsTrack');
  const container = document.getElementById('tabsContainer');
  const btnL = document.getElementById('btnLeft');
  const btnR = document.getElementById('btnRight');
  let pos = 0;
  let maxScroll = 0;
  let startX = 0, dragStart = 0, isDown = false;

  function updateLimits(){
    const trackWidth = track.scrollWidth;
    const viewport = container.clientWidth;
    maxScroll = Math.max(0, trackWidth - viewport);
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    btnL.disabled = pos === 0;
    btnR.disabled = Math.abs(pos) >= maxScroll;
  }

  function scrollBy(direction){
    const step = Math.round(container.clientWidth * 0.6);
    pos += (direction === 'left') ? step : -step;
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  }

  btnL.addEventListener('click', ()=> scrollBy('left'));
  btnR.addEventListener('click', ()=> scrollBy('right'));

  track.addEventListener('pointerdown', (e)=>{
    isDown = true;
    startX = e.clientX;
    dragStart = pos;
    track.style.transition = 'none';
    track.setPointerCapture(e.pointerId);
  });
  window.addEventListener('pointermove', (e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX;
    pos = dragStart + dx;
    if(pos > 80) pos = 80;
    if(pos < -maxScroll - 80) pos = -maxScroll - 80;
    track.style.transform = `translateX(${pos}px)`;
  });
  window.addEventListener('pointerup', ()=>{
    if(!isDown) return;
    isDown = false;
    track.style.transition = 'transform .35s ease';
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  });
  window.addEventListener('resize', updateLimits);
  window.addEventListener('load', ()=> setTimeout(updateLimits, 80));
})();
</script>

</body>


<script>
(function(){
  const track = document.getElementById('tabsTrack');
  const container = document.getElementById('tabsContainer');
  const btnL = document.getElementById('btnLeft');
  const btnR = document.getElementById('btnRight');
  let pos = 0;
  let maxScroll = 0;
  let startX = 0, dragStart = 0, isDown = false;

  function updateLimits(){
    const trackWidth = track.scrollWidth;
    const viewport = container.clientWidth;
    maxScroll = Math.max(0, trackWidth - viewport);
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    btnL.disabled = pos === 0;
    btnR.disabled = Math.abs(pos) >= maxScroll;
  }

  function scrollBy(direction){
    const step = Math.round(container.clientWidth * 0.6);
    pos += (direction === 'left') ? step : -step;
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  }

  btnL.addEventListener('click', ()=> scrollBy('left'));
  btnR.addEventListener('click', ()=> scrollBy('right'));

  track.addEventListener('pointerdown', (e)=>{
    isDown = true;
    startX = e.clientX;
    dragStart = pos;
    track.style.transition = 'none';
    track.setPointerCapture(e.pointerId);
  });
  window.addEventListener('pointermove', (e)=>{
    if(!isDown) return;
    const dx = e.clientX - startX;
    pos = dragStart + dx;
    if(pos > 80) pos = 80;
    if(pos < -maxScroll - 80) pos = -maxScroll - 80;
    track.style.transform = `translateX(${pos}px)`;
  });
  window.addEventListener('pointerup', ()=>{
    if(!isDown) return;
    isDown = false;
    track.style.transition = 'transform .35s ease';
    pos = Math.max(-maxScroll, Math.min(0, pos));
    track.style.transform = `translateX(${pos}px)`;
    updateLimits();
  });
  window.addEventListener('resize', updateLimits);
  window.addEventListener('load', ()=> setTimeout(updateLimits, 80));
})();
</script>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Калькулятор депозита — простой и сложный процент</title>
<style>
  :root{
    --bg:#f4f7fb;
    --card:#fff;
    --accent:#050506;
    --muted:#6b7280;
    --glass: rgba(255,255,255,0.8);
  }
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background:linear-gradient(180deg,var(--bg),#eef4ff 120%);
    color:#0f1724;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
  }
  .container{
    max-width:1160px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:20px;
    align-items:start;
  }

  /* Card */
  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:0 10px 30px rgba(17,24,39,0.06);
  }
  h1{font-size:20px;margin:0 0 8px}
  p.lead{margin:0 0 14px;color:var(--muted);font-size:14px}

  /* Form */
  .field{display:flex;flex-direction:column;margin-bottom:12px}
  .field label{font-size:13px;margin-bottom:6px;color:#111827}
  .field input[type="number"], .field input[type="text"], .field select {
    padding:10px 12px;border-radius:8px;border:1px solid #e6eef8;background:transparent;
    font-size:14px;outline:none;
  }
  .inline{
    display:flex;gap:10px;
  }
  .inline .field{flex:1}

  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{
    padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff;cursor:pointer;font-size:13px;
  }
  .radio input{display:none}
  .radio.active{border-color:var(--accent);box-shadow:0 6px 18px rgba(23,102,255,0.08);background:linear-gradient(180deg,#f5f9ff,#fff)}

  .actions{display:flex;gap:10px;align-items:center;margin-top:8px}
  .btn{
    padding:10px 14px;border-radius:9px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:600;
    box-shadow:0 8px 22px rgba(23,102,255,0.12);
  }
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(23,102,255,0.12);box-shadow:none}

  /* Output */
  .output-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .stat{background:linear-gradient(180deg,#fbfdff,#fff);padding:12px;border-radius:10px;border:1px solid #eef6ff}
  .stat h3{margin:0;font-size:16px}
  .stat p{margin:6px 0 0;color:var(--muted);font-size:13px}

  /* Table */
  .table-wrap{overflow:auto;margin-top:14px;border-radius:8px;border:1px solid #eef6ff}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #f3f6fb}
  th{background:#fbfdff;position:sticky;top:0}

  /* Chart */
  #chart{width:100%;height:260px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);display:block}

  /* Footer notes */
  .notes{color:var(--muted);font-size:13px;margin-top:10px}

  @media(max-width:980px){
    .container{grid-template-columns:1fr; padding:0 10px}
  }

  /* small helpers */
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <!-- LEFT: Form -->
    <div class="card">
      <h1>Калькулятор депозита</h1>
      <p class="lead">Выберите тип процента, введите сумму, ставку и срок — получите итоговую сумму, процент и график.</p>

      <div class="field">
        <label>Тип процента</label>
        <div class="radio-row" id="typeChoice">
          <label class="radio active" data-type="compound"><input type="radio" name="type" checked /> Сложный (капитализация)</label>
          <label class="radio" data-type="simple"><input type="radio" name="type" /> Простой</label>
        </div>
      </div>

      <div class="field">
        <label>Начальная сумма (₸ / ₽ / $)</label>
        <input id="principal" type="number" min="0" value="100000" step="any" />
      </div>

      <div class="inline">
        <div class="field">
          <label>Годовая ставка (%)</label>
          <input id="rate" type="number" min="0" step="any" value="12" />
        </div>
        <div class="field">
          <label>Срок (лет)</label>
          <input id="years" type="number" min="0" step="any" value="3" />
        </div>
      </div>

      <div class="field" id="compoundFreqRow">
        <label>Частота капитализации</label>
        <select id="freq">
          <option value="1">Ежегодно (1)</option>
          <option value="2">2 раза в год (полугодие)</option>
          <option value="4">Ежеквартально (4)</option>
          <option value="12" selected>Ежемесячно (12)</option>
          <option value="365">Ежедневно (365)</option>
          <option value="continuous">Непрерывно</option>
        </select>
      </div>

      <div class="inline">
        <div class="field">
          <label>Периодический взнос (PMT) — сумма добавляемая каждый период</label>
          <input id="pmt" type="number" min="0" step="any" value="0" />
          <span class="small muted">Если нет — оставьте 0. Взнос считается в конце периода.</span>
        </div>
        <div class="field">
          <label>Валюта (для вывода)</label>
          <input id="currency" type="text" value="₸" />
        </div>
      </div>

      <div class="field">
        <label>Параметры отображения</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn" id="calcBtn">Рассчитать</button>
          <button class="btn ghost" id="resetBtn" title="Сбросить">Сброс</button>
          <button class="btn ghost" id="csvBtn" title="Скачать таблицу CSV">Скачать CSV</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Results -->
    <div>
      <div class="card">
        <h1>Результат</h1>
        <div style="margin-top:8px" id="resultSummary">
          <p class="small muted">Нажмите «Рассчитать», чтобы увидеть детали.</p>
        </div>

        <div style="margin-top:10px" id="stats" class="output-grid" hidden>
          <div class="stat">
            <h3 id="finalAmount">—</h3>
            <p>Итоговая сумма (A)</p>
          </div>
          <div class="stat">
            <h3 id="totalInterest">—</h3>
            <p>Накопленные проценты</p>
          </div>
          <div class="stat">
            <h3 id="initial">—</h3>
            <p>Начальная сумма (P)</p>
          </div>
          <div class="stat">
            <h3 id="effectiveRate">—</h3>
            <p>Эффективная годовая ставка (APR эквивалент)</p>
          </div>
        </div>

        <canvas id="chart"></canvas>

        <div class="table-wrap card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 6px 0 6px">
            <strong>График по периодам</strong>
            <span class="small muted" id="tableInfo"></span>
          </div>
          <div style="padding:6px">
            <table id="scheduleTable">
              <thead>
                <tr>
                  <th>Период</th>
                  <th>Баланс на начало</th>
                  <th>Процент</th>
                  <th>Взнос (PMT)</th>
                  <th>Баланс на конец</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/*
  Deposit calculator logic:
  - supports simple and compound interest
  - supports periodic contributions (PMT), contributions at end of period
  - supports continuous compounding
  - builds schedule per period and plots growth on canvas
*/

function $(id){ return document.getElementById(id); }

const typeChoice = document.getElementById('typeChoice');
const radios = Array.from(typeChoice.querySelectorAll('.radio'));
const freqRow = $('compoundFreqRow');
const calcBtn = $('calcBtn');
const resetBtn = $('resetBtn');
const csvBtn = $('csvBtn');
const stats = $('stats');
const scheduleTBody = document.querySelector('#scheduleTable tbody');
const chart = document.getElementById('chart');
const ctx = chart.getContext ? chart.getContext('2d') : null;

let lastSchedule = null;

// Toggle radio visuals
radios.forEach(r => {
  r.addEventListener('click', () => {
    radios.forEach(x => x.classList.remove('active'));
    r.classList.add('active');
    // show/hide frequency for simple interest
    const type = r.dataset.type;
    if(type === 'simple') freqRow.style.display = 'none';
    else freqRow.style.display = '';
  });
});

// Utility formatting
function fmt(num, currency='') {
  if (Number.isNaN(num) || !isFinite(num)) return '-';
  // format with thousands and 2 decimals
  return currency + Number(num).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

// Calculation core
function calculate(){
  const type = radios.find(r=>r.classList.contains('active')).dataset.type;
  const P = parseFloat($('principal').value) || 0;
  const ratePct = parseFloat($('rate').value) || 0;
  const years = parseFloat($('years').value) || 0;
  const freqVal = $('freq').value;
  const pmt = parseFloat($('pmt').value) || 0;
  const currency = $('currency').value || '';

  const r = ratePct / 100;

  // Edge cases:
  if(years === 0){
    alert('Срок должен быть больше 0 лет.');
    return;
  }

  let A = 0;
  let effectiveAPR = ratePct; // default
  let schedule = [];

  if(type === 'simple'){
    // simple interest: A = P*(1 + r * t) + PMT_series? For PMT we assume contributions don't earn compound interest,
    // but they will earn simple interest proportional to time remaining. For simplicity: we'll treat PMT as periodic contributions
    // that earn simple interest from contribution time to the end.
    A = P * (1 + r * years);

    // If PMT > 0, contributions made each period (we'll choose monthly periods for schedule if PMT used)
    let periods = Math.round(years * 12) || 1;
    let periodRate = r / 12;
    // contributions at end of each period: each contribution's interest = PMT * r * (remainingYears)
    let sumPMTfuture = 0;
    schedule = [];
    let balance = P;
    for(let i=1;i<=periods;i++){
      const timeLeftYears = (years - (i/12));
      const interestForThisPeriod = balance * (r/12); // simple method: apply monthly simple rate to current balance
      balance = balance + interestForThisPeriod + (pmt);
      schedule.push({
        period:i,
        start: balance - interestForThisPeriod - pmt,
        interest: interestForThisPeriod,
        pmt: pmt,
        end: balance
      });
      sumPMTfuture += pmt;
    }
    A = balance;
    effectiveAPR = ratePct;
  } else {
    // compound
    let periodsPerYear, continuous=false;
    if(freqVal === 'continuous'){ continuous = true; periodsPerYear = null; }
    else periodsPerYear = parseInt(freqVal,10) || 1;

    if(continuous){
      // continuous compounding for principal
      A = P * Math.exp(r * years);
      // contributions (PMT) with continuous compounding: integrate — formula for continuous contributions at rate r:
      // FV_series = PMT * ( (e^{r*t} - 1) / (e^{r/periodsPerYear} - 1) ) — complicated; we approximate contributions as frequent (daily)
      if(pmt > 0){
        // approximate using monthly contributions (n=12)
        const n = 12;
        const nt = n * years;
        const periodicRate = r / n;
        const factor = Math.pow(1 + periodicRate, nt);
        const fvSeries = pmt * ( (factor - 1) / periodicRate );
        A += fvSeries;
      }
      effectiveAPR = (Math.exp(r) - 1) * 100;
      // build monthly schedule (approx)
      const n = 12;
      const totalPeriods = Math.round(years * n);
      let bal = P;
      schedule = [];
      for(let i=1;i<=totalPeriods;i++){
        const periodRate = r / n;
        const interest = bal * periodRate;
        const start = bal;
        bal = bal + interest + pmt;
        schedule.push({period:i, start, interest, pmt, end:bal});
      }
    } else {
      const n = periodsPerYear;
      const nt = n * years;
      const periodicRate = r / n;
      // principal growth
      A = P * Math.pow(1 + periodicRate, nt);
      // contributions (PMT at end of period): FV = PMT * ( ( (1 + i)^{nt} - 1 ) / i )
      let fvSeries = 0;
      if(pmt > 0){
        if(periodicRate === 0){
          fvSeries = pmt * nt;
        } else {
          fvSeries = pmt * ( (Math.pow(1 + periodicRate, nt) - 1) / periodicRate );
        }
        A += fvSeries;
      }
      // effective APR (APY) = (1 + r/n)^n - 1
      effectiveAPR = (Math.pow(1 + periodicRate, n) - 1) * 100;

      // schedule per period
      let bal = P;
      schedule = [];
      for(let i=1;i<=nt;i++){
        const interest = bal * periodicRate;
        const start = bal;
        bal = bal + interest + pmt;
        schedule.push({period:i, start, interest, pmt, end:bal});
      }
    }
  }

  const totalInterest = A - P - (parseFloat($('pmt').value) || 0) * (schedule.length || 0);

  // fill summary
  $('resultSummary').innerHTML = `
    <p class="small muted">Тип: <strong>${type === 'simple' ? 'Простой процент' : 'Сложный процент'}</strong> • Ставка: <strong>${ratePct}%</strong> • Срок: <strong>${years} лет</strong></p>
  `;

  $('finalAmount').innerText = fmt(A, $('currency').value);
  $('totalInterest').innerText = fmt(A - P - (pmt * (schedule.length || 0)), $('currency').value);
  $('initial').innerText = fmt(P, $('currency').value);
  $('effectiveRate').innerText = isFinite(effectiveAPR) ? effectiveAPR.toFixed(4) + '%' : '-';

  stats.hidden = false;

  // populate table
  scheduleTBody.innerHTML = '';
  if(schedule.length === 0){
    // For simple without PMT maybe create yearly row
    schedule = [];
    let balStart = P;
    for(let y=1;y<=Math.round(years);y++){
      const interest = type==='simple' ? P * (r) * 1 : balStart * (Math.pow(1 + r,1) - 1);
      const end = balStart + interest;
      schedule.push({period:y, start: balStart, interest, pmt:0, end});
      balStart = end;
    }
  }
  schedule.forEach(row=>{
    const tr = document.createElement('tr');
    const formatN = v => fmt(v, $('currency').value);
    tr.innerHTML = `<td>${row.period}</td>
                    <td>${formatN(row.start)}</td>
                    <td>${formatN(row.interest)}</td>
                    <td>${formatN(row.pmt)}</td>
                    <td>${formatN(row.end)}</td>`;
    scheduleTBody.appendChild(tr);
  });

  lastSchedule = { schedule, currency: $('currency').value };

  $('tableInfo').innerText = `Всего периодов: ${schedule.length}`;

  // draw chart
  drawChart(schedule.map(s=>s.end), $('currency').value);
}

// Chart drawing (simple) using canvas 2D context
function drawChart(values, currency){
  if(!ctx) return;
  // clear
  chart.width = chart.clientWidth * devicePixelRatio;
  chart.height = chart.clientHeight * devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  ctx.clearRect(0,0,chart.width,chart.height);

  const w = chart.clientWidth;
  const h = chart.clientHeight;
  ctx.font = '12px Inter, Arial';
  ctx.fillStyle = '#0f1724';

  if(values.length === 0){
    ctx.fillText('Нет данных для графика', 10, 20);
    return;
  }
  const margin = {left:50,right:20,top:20,bottom:30};
  const plotW = w - margin.left - margin.right;
  const plotH = h - margin.top - margin.bottom;

  const min = Math.min(...values, 0);
  const max = Math.max(...values);
  const range = max - min || 1;

  // axes
  ctx.strokeStyle = '#e7eefc';
  ctx.lineWidth = 1;
  // grid horizontal lines
  ctx.beginPath();
  ctx.moveTo(margin.left, margin.top);
  ctx.lineTo(margin.left, margin.top + plotH);
  ctx.lineTo(margin.left + plotW, margin.top + plotH);
  ctx.stroke();

  // y labels and grid
  ctx.fillStyle = '#6b7280';
  ctx.textAlign = 'right';
  const steps = 4;
  for(let i=0;i<=steps;i++){
    const y = margin.top + (i/steps) * plotH;
    const val = max - (i/steps) * range;
    ctx.fillText(currency + Number(val).toLocaleString(undefined,{maximumFractionDigits:0}), margin.left - 8, y + 4);
    // grid line
    ctx.strokeStyle = '#eef6ff';
    ctx.beginPath();
    ctx.moveTo(margin.left, y);
    ctx.lineTo(margin.left + plotW, y);
    ctx.stroke();
  }

  // x labels
  ctx.textAlign = 'center';
  const N = values.length;
  const stepX = plotW / Math.max(1, N-1);
  for(let i=0;i<N;i++){
    if(i % Math.ceil(N/6) === 0 || i===N-1){
      const x = margin.left + i * stepX;
      ctx.fillStyle = '#6b7280';
      ctx.fillText(i+1, x, margin.top + plotH + 18);
    }
  }

  // polyline
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const x = margin.left + i * stepX;
    const y = margin.top + ((max - values[i]) / range) * plotH;
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = '#1766ff';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // fill under curve
  ctx.lineTo(margin.left + plotW, margin.top + plotH);
  ctx.lineTo(margin.left, margin.top + plotH);
  ctx.closePath();
  const grd = ctx.createLinearGradient(0, margin.top, 0, margin.top + plotH);
  grd.addColorStop(0, 'rgba(23,102,255,0.18)');
  grd.addColorStop(1, 'rgba(23,102,255,0.03)');
  ctx.fillStyle = grd;
  ctx.fill();

  // title
  ctx.fillStyle = '#0f1724';
  ctx.textAlign = 'left';
  ctx.fillText('Рост баланса по периодам', margin.left, margin.top - 6);
}

// CSV export
function downloadCSV(){
  if(!lastSchedule || !lastSchedule.schedule) {
    alert('Сначала выполните расчёт.');
    return;
  }
  const rows = [['Период','Баланс на начало','Процент','Взнос (PMT)','Баланс на конец']];
  lastSchedule.schedule.forEach(r=>{
    rows.push([r.period, r.start, r.interest, r.pmt, r.end]);
  });
  const csvContent = rows.map(r=>r.map(v=>{
    // remove currency from numbers if present
    if(typeof v === 'string') return '"' + v.replace(/"/g,'""') + '"';
    return v;
  }).join(',')).join('\n');

  const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'deposit_schedule.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Events
calcBtn.addEventListener('click', calculate);
resetBtn.addEventListener('click', ()=>{
  $('principal').value = 100000;
  $('rate').value = 12;
  $('years').value = 3;
  $('freq').value = '12';
  $('pmt').value = 0;
  $('currency').value = '₸';
  radios.forEach(r=>r.classList.remove('active'));
  radios[0].classList.add('active');
  $('resultSummary').innerHTML = '<p class="small muted">Нажмите «Рассчитать», чтобы увидеть детали.</p>';
  stats.hidden = true;
  scheduleTBody.innerHTML = '';
  lastSchedule = null;
  // clear chart
  if(ctx){
    ctx.clearRect(0,0,chart.clientWidth,chart.clientHeight);
  }
});
csvBtn.addEventListener('click', downloadCSV);

// initial draw
window.addEventListener('load', ()=>{
  // set canvas size to responsive
  function resizeCanvas(){
    chart.style.width = '100%';
    chart.style.height = '260px';
    chart.width = chart.clientWidth * devicePixelRatio;
    chart.height = chart.clientHeight * devicePixelRatio;
    if(lastSchedule) drawChart(lastSchedule.schedule.map(s=>s.end), lastSchedule.currency);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
});
</script>
</body>
</html>
